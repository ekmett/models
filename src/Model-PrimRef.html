<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Model/PrimRef.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE MagicHash #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE RoleAnnotations #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE UnboxedTuples #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE Unsafe #-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Model</span><span class='hs-varop'>.</span><span class='hs-conid'>PrimRef</span>
<a name="line-8"></a>  <span class='hs-layout'>(</span> 
<a name="line-9"></a>  <span class='hs-comment'>-- * Primitive References</span>
<a name="line-10"></a>    <span class='hs-conid'>PrimRef</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>newPrimRef</span>
<a name="line-12"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>newPinnedPrimRef</span>
<a name="line-13"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>newAlignedPinnedPrimRef</span>
<a name="line-14"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>readPrimRef</span>
<a name="line-15"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>writePrimRef</span>
<a name="line-16"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>primRefContents</span>
<a name="line-17"></a>  <span class='hs-comment'>-- * Frozen Primitive References</span>
<a name="line-18"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>FrozenPrimRef</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>newFrozenPrimRef</span>
<a name="line-20"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>unsafeFreezePrimRef</span>
<a name="line-21"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>unsafeThawPrimRef</span>
<a name="line-22"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>indexFrozenPrimRef</span>
<a name="line-23"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>frozenPrimRefContents</span>
<a name="line-24"></a>  <span class='hs-comment'>-- * Atomic Operations</span>
<a name="line-25"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>casInt</span>
<a name="line-26"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fetchAddInt</span>
<a name="line-27"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fetchSubInt</span>
<a name="line-28"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fetchAndInt</span>
<a name="line-29"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fetchNandInt</span>
<a name="line-30"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fetchOrInt</span>
<a name="line-31"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fetchXorInt</span>
<a name="line-32"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>atomicReadInt</span>
<a name="line-33"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>atomicWriteInt</span>
<a name="line-34"></a>  <span class='hs-comment'>-- * Prefetching</span>
<a name="line-35"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>prefetchPrimRef0</span>
<a name="line-36"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>prefetchPrimRef1</span>
<a name="line-37"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>prefetchPrimRef2</span>
<a name="line-38"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>prefetchPrimRef3</span>
<a name="line-39"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>prefetchFrozenPrimRef0</span>
<a name="line-40"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>prefetchFrozenPrimRef1</span>
<a name="line-41"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>prefetchFrozenPrimRef2</span>
<a name="line-42"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>prefetchFrozenPrimRef3</span>
<a name="line-43"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Primitive</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>ST</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Primitive</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Model</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span><span class='hs-varop'>.</span><span class='hs-conid'>Util</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Prim</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-cpp'>#ifdef HLINT</span>
<a name="line-54"></a><span class='hs-comment'>{-# ANN module "HLint: ignore Eta reduce" #-}</span>
<a name="line-55"></a><span class='hs-comment'>{-# ANN module "HLint: ignore Reduce duplication" #-}</span>
<a name="line-56"></a><span class='hs-cpp'>#endif</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-59"></a><span class='hs-comment'>-- * Primitive References</span>
<a name="line-60"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="PrimRef"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>PrimRef</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>MutableByteArray</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-cpp'>#ifndef HLINT</span>
<a name="line-65"></a><span class='hs-keyword'>type</span> <span class='hs-varid'>role</span> <span class='hs-conid'>PrimRef</span> <span class='hs-varid'>nominal</span> <span class='hs-varid'>nominal</span>
<a name="line-66"></a><span class='hs-cpp'>#endif</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="newPrimRef"></a><span class='hs-comment'>-- | Create a primitive reference.</span>
<a name="line-69"></a><span class='hs-definition'>newPrimRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Prim</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-definition'>newPrimRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-71"></a>  <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newByteArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>sizeOf</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-72"></a>  <span class='hs-varid'>writeByteArray</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span> <span class='hs-varid'>a</span>
<a name="line-73"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-74"></a><span class='hs-comment'>{-# INLINE newPrimRef #-}</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="newPinnedPrimRef"></a><span class='hs-comment'>-- | Create a pinned primitive reference.</span>
<a name="line-77"></a><span class='hs-definition'>newPinnedPrimRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Prim</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-78"></a><span class='hs-definition'>newPinnedPrimRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-79"></a>  <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newPinnedByteArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>sizeOf</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-80"></a>  <span class='hs-varid'>writeByteArray</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span> <span class='hs-varid'>a</span>
<a name="line-81"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-82"></a><span class='hs-comment'>{-# INLINE newPinnedPrimRef #-}</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="newAlignedPinnedPrimRef"></a><span class='hs-comment'>-- | Create a pinned primitive reference with the appropriate alignment for its contents.</span>
<a name="line-85"></a><span class='hs-definition'>newAlignedPinnedPrimRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Prim</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-definition'>newAlignedPinnedPrimRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-87"></a>  <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newAlignedPinnedByteArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>sizeOf</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>alignment</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-88"></a>  <span class='hs-varid'>writeByteArray</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span> <span class='hs-varid'>a</span>
<a name="line-89"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-90"></a><span class='hs-comment'>{-# INLINE newAlignedPinnedPrimRef #-}</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="readPrimRef"></a><span class='hs-comment'>-- | Read a primitive value from the reference</span>
<a name="line-93"></a><span class='hs-definition'>readPrimRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Prim</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-94"></a><span class='hs-definition'>readPrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readByteArray</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span>
<a name="line-95"></a><span class='hs-comment'>{-# INLINE readPrimRef #-}</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="writePrimRef"></a><span class='hs-comment'>-- | Write a primitive value to the reference</span>
<a name="line-98"></a><span class='hs-definition'>writePrimRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Prim</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-99"></a><span class='hs-definition'>writePrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeByteArray</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span> <span class='hs-varid'>a</span>
<a name="line-100"></a><span class='hs-comment'>{-# INLINE writePrimRef #-}</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="instance%20Eq%20(PrimRef%20s%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-103"></a>  <span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span> <span class='hs-varop'>==</span> <span class='hs-conid'>PrimRef</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sameMutableByteArray</span> <span class='hs-varid'>m</span> <span class='hs-varid'>n</span>
<a name="line-104"></a>  <span class='hs-comment'>{-# INLINE (==) #-}</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="primRefContents"></a><span class='hs-comment'>-- | Yield a pointer to the data of a 'PrimRef'. This operation is only safe on pinned byte arrays allocated by</span>
<a name="line-107"></a><span class='hs-comment'>-- 'newPinnedPrimRef' or 'newAlignedPinnedPrimRef'.</span>
<a name="line-108"></a><span class='hs-definition'>primRefContents</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimRef</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Addr</span>
<a name="line-109"></a><span class='hs-definition'>primRefContents</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mutableByteArrayContents</span> <span class='hs-varid'>m</span>
<a name="line-110"></a><span class='hs-comment'>{-# INLINE primRefContents #-}</span>
<a name="line-111"></a>
<a name="line-112"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-113"></a><span class='hs-comment'>-- * Frozen Primitive References</span>
<a name="line-114"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="unsafeFreezePrimRef"></a><span class='hs-comment'>-- | Convert a mutable 'PrimRef' to an immutable one without copying. The reference should not be modified after the conversion.</span>
<a name="line-117"></a><span class='hs-definition'>unsafeFreezePrimRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-118"></a><span class='hs-definition'>unsafeFreezePrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>unsafeFreezeByteArray</span> <span class='hs-varid'>m</span>
<a name="line-119"></a><span class='hs-comment'>{-# INLINE unsafeFreezePrimRef #-}</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="FrozenPrimRef"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FrozenPrimRef</span> <span class='hs-conid'>ByteArray</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-cpp'>#ifndef HLINT</span>
<a name="line-124"></a><span class='hs-keyword'>type</span> <span class='hs-varid'>role</span> <span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>nominal</span>
<a name="line-125"></a><span class='hs-cpp'>#endif</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="newFrozenPrimRef"></a><span class='hs-definition'>newFrozenPrimRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Prim</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>a</span>
<a name="line-128"></a><span class='hs-definition'>newFrozenPrimRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runST</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newPrimRef</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>unsafeFreezePrimRef</span>
<a name="line-129"></a>
<a name="line-130"></a><a name="indexFrozenPrimRef"></a><span class='hs-comment'>-- | Read the stored primitive value from the frozen reference.</span>
<a name="line-131"></a><span class='hs-definition'>indexFrozenPrimRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Prim</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-132"></a><span class='hs-definition'>indexFrozenPrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>ba</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>indexByteArray</span> <span class='hs-varid'>ba</span> <span class='hs-num'>0</span>
<a name="line-133"></a><span class='hs-comment'>{-# INLINE indexFrozenPrimRef #-}</span>
<a name="line-134"></a>
<a name="line-135"></a><a name="unsafeThawPrimRef"></a><span class='hs-comment'>-- | Convert an immutable primitive reference to a mutable one without copying. The original reference should not be used after the conversion.</span>
<a name="line-136"></a><span class='hs-definition'>unsafeThawPrimRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-137"></a><span class='hs-definition'>unsafeThawPrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PrimRef</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>unsafeThawByteArray</span> <span class='hs-varid'>m</span>
<a name="line-138"></a><span class='hs-comment'>{-# INLINE unsafeThawPrimRef #-}</span>
<a name="line-139"></a>
<a name="line-140"></a><a name="frozenPrimRefContents"></a><span class='hs-comment'>-- | Yield a pointer to the data of a 'FrozenPrimRef'. This operation is only safe on pinned byte arrays allocated by</span>
<a name="line-141"></a><span class='hs-comment'>-- 'newPinnedPrimRef' or 'newAlignedPinnedPrimRef' and then subsequently frozen.</span>
<a name="line-142"></a><span class='hs-definition'>frozenPrimRefContents</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Addr</span>
<a name="line-143"></a><span class='hs-definition'>frozenPrimRefContents</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>byteArrayContents</span> <span class='hs-varid'>m</span>
<a name="line-144"></a><span class='hs-comment'>{-# INLINE frozenPrimRefContents #-}</span>
<a name="line-145"></a>
<a name="line-146"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-147"></a><span class='hs-comment'>-- * Atomic Operations</span>
<a name="line-148"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="casInt"></a><span class='hs-comment'>-- | Given a primitive reference, the expected old value, and the new value, perform an atomic compare and swap i.e. write the new value if the current value matches the provided old value. Returns the value of the element before the operation. Implies a full memory barrier.</span>
<a name="line-151"></a><span class='hs-definition'>casInt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Int</span>
<a name="line-152"></a><span class='hs-definition'>casInt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>MutableByteArray</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>old</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>new</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primitive</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>casIntArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>old</span> <span class='hs-varid'>new</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-153"></a>  <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-154"></a>
<a name="line-155"></a><a name="fetchAddInt"></a><span class='hs-comment'>-- | Given a reference, and a value to add, atomically add the value to the element. Returns the value of the element before the operation. Implies a full memory barrier.</span>
<a name="line-156"></a><span class='hs-definition'>fetchAddInt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Int</span>
<a name="line-157"></a><span class='hs-definition'>fetchAddInt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>MutableByteArray</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primitive</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fetchAddIntArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-158"></a>  <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-159"></a>
<a name="line-160"></a><a name="fetchSubInt"></a><span class='hs-comment'>-- | Given a reference, and a value to subtract, atomically subtract the value from the element. Returns the value of the element before the operation. Implies a full memory barrier.</span>
<a name="line-161"></a><span class='hs-definition'>fetchSubInt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Int</span>
<a name="line-162"></a><span class='hs-definition'>fetchSubInt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>MutableByteArray</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primitive</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fetchSubIntArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-163"></a>  <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-164"></a>
<a name="line-165"></a><a name="fetchAndInt"></a><span class='hs-comment'>-- | Given a reference, and a value to bitwise and, atomically and the value with the element. Returns the value of the element before the operation. Implies a full memory barrier.</span>
<a name="line-166"></a><span class='hs-definition'>fetchAndInt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Int</span>
<a name="line-167"></a><span class='hs-definition'>fetchAndInt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>MutableByteArray</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primitive</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fetchAndIntArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-168"></a>  <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-169"></a>
<a name="line-170"></a><a name="fetchNandInt"></a><span class='hs-comment'>-- | Given a reference, and a value to bitwise nand, atomically nand the value with the element. Returns the value of the element before the operation. Implies a full memory barrier.</span>
<a name="line-171"></a><span class='hs-definition'>fetchNandInt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Int</span>
<a name="line-172"></a><span class='hs-definition'>fetchNandInt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>MutableByteArray</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primitive</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fetchNandIntArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-173"></a>  <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="fetchOrInt"></a><span class='hs-comment'>-- | Given a reference, and a value to bitwise or, atomically or the value with the element. Returns the value of the element before the operation. Implies a full memory barrier.</span>
<a name="line-176"></a><span class='hs-definition'>fetchOrInt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Int</span>
<a name="line-177"></a><span class='hs-definition'>fetchOrInt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>MutableByteArray</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primitive</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fetchOrIntArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-178"></a>  <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-179"></a>
<a name="line-180"></a><a name="fetchXorInt"></a><span class='hs-comment'>-- | Given a reference, and a value to bitwise xor, atomically xor the value with the element. Returns the value of the element before the operation. Implies a full memory barrier.</span>
<a name="line-181"></a><span class='hs-definition'>fetchXorInt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Int</span>
<a name="line-182"></a><span class='hs-definition'>fetchXorInt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>MutableByteArray</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primitive</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fetchXorIntArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-183"></a>  <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="atomicReadInt"></a><span class='hs-comment'>-- | Given a reference, read an element. Implies a full memory barrier.</span>
<a name="line-186"></a><span class='hs-definition'>atomicReadInt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Int</span>
<a name="line-187"></a><span class='hs-definition'>atomicReadInt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>MutableByteArray</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primitive</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>atomicReadIntArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-188"></a>  <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="atomicWriteInt"></a><span class='hs-comment'>-- | Given a reference, write an element. Implies a full memory barrier.</span>
<a name="line-191"></a><span class='hs-definition'>atomicWriteInt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-192"></a><span class='hs-definition'>atomicWriteInt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>MutableByteArray</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primitive_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>atomicWriteIntArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span>
<a name="line-193"></a>
<a name="line-194"></a><a name="instance%20Data%20(FrozenPrimRef%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prim</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Data</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-195"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-varid'>f</span> <span class='hs-varid'>z</span> <span class='hs-varid'>m</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-varid'>newFrozenPrimRef</span> <span class='hs-varop'>`f`</span> <span class='hs-varid'>indexFrozenPrimRef</span> <span class='hs-varid'>m</span>
<a name="line-196"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newFrozenPrimRefConstr</span>
<a name="line-197"></a>  <span class='hs-varid'>gunfold</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-varid'>c</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>constrIndex</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>of</span>
<a name="line-198"></a>    <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>z</span> <span class='hs-varid'>newFrozenPrimRef</span><span class='hs-layout'>)</span>
<a name="line-199"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-200"></a>  <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>frozenPrimRefDataType</span>
<a name="line-201"></a>
<a name="line-202"></a><a name="newFrozenPrimRefConstr"></a><span class='hs-definition'>newFrozenPrimRefConstr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Constr</span>
<a name="line-203"></a><span class='hs-definition'>newFrozenPrimRefConstr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkConstr</span> <span class='hs-varid'>frozenPrimRefDataType</span> <span class='hs-str'>"newFrozenPrimRef"</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>Prefix</span>
<a name="line-204"></a>
<a name="line-205"></a><a name="frozenPrimRefDataType"></a><span class='hs-definition'>frozenPrimRefDataType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataType</span>
<a name="line-206"></a><span class='hs-definition'>frozenPrimRefDataType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkDataType</span> <span class='hs-str'>"Data.Transient.Primitive.FrozenPrimRef"</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>newFrozenPrimRefConstr</span><span class='hs-keyglyph'>]</span>
<a name="line-207"></a>
<a name="line-208"></a><a name="prefetchPrimRef0"></a><span class='hs-definition'>prefetchPrimRef0</span><span class='hs-layout'>,</span> <span class='hs-varid'>prefetchPrimRef1</span><span class='hs-layout'>,</span> <span class='hs-varid'>prefetchPrimRef2</span><span class='hs-layout'>,</span> <span class='hs-varid'>prefetchPrimRef3</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PrimRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-209"></a><span class='hs-definition'>prefetchPrimRef0</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefetchMutableByteArray0</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span>
<a name="line-210"></a><a name="prefetchPrimRef1"></a><span class='hs-definition'>prefetchPrimRef1</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefetchMutableByteArray1</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span>
<a name="line-211"></a><a name="prefetchPrimRef2"></a><span class='hs-definition'>prefetchPrimRef2</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefetchMutableByteArray2</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span>
<a name="line-212"></a><a name="prefetchPrimRef3"></a><span class='hs-definition'>prefetchPrimRef3</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefetchMutableByteArray3</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span>
<a name="line-213"></a>
<a name="line-214"></a><a name="prefetchFrozenPrimRef0"></a><span class='hs-definition'>prefetchFrozenPrimRef0</span><span class='hs-layout'>,</span> <span class='hs-varid'>prefetchFrozenPrimRef1</span><span class='hs-layout'>,</span> <span class='hs-varid'>prefetchFrozenPrimRef2</span><span class='hs-layout'>,</span> <span class='hs-varid'>prefetchFrozenPrimRef3</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-215"></a><span class='hs-definition'>prefetchFrozenPrimRef0</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefetchByteArray0</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span>
<a name="line-216"></a><a name="prefetchFrozenPrimRef1"></a><span class='hs-definition'>prefetchFrozenPrimRef1</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefetchByteArray1</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span>
<a name="line-217"></a><a name="prefetchFrozenPrimRef2"></a><span class='hs-definition'>prefetchFrozenPrimRef2</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefetchByteArray2</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span>
<a name="line-218"></a><a name="prefetchFrozenPrimRef3"></a><span class='hs-definition'>prefetchFrozenPrimRef3</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrozenPrimRef</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefetchByteArray3</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span>
</pre></body>
</html>
